{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}

{% block title %}Order {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-md-8">
        <h4>
          <i class="fa fa-play me-2"></i>Order {{ order.order_number }}
          {% if vehicle %}
            <small class="text-muted ms-2"><i class="fa fa-car"></i> {{ vehicle.plate_number }}</small>
          {% endif %}
        </h4>
      </div>
      <div class="col-md-4">
        <ol class="breadcrumb justify-content-end">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item"><a href="{% url 'tracker:started_orders_dashboard' %}">Started Orders</a></li>
          <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-left border-4" style="border-left-color: #667eea;">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-md-6">
              <p class="mb-2"><strong>Status:</strong> <span class="badge bg-secondary">New</span></p>
              <p class="mb-0"><strong>Started:</strong> <span class="text-muted">{{ order.started_at|date:"M d, Y H:i" }}</span></p>
            </div>
            <div class="col-md-6 text-md-end">
              <p class="mb-2"><strong>Type:</strong> 
                {% if order.type == 'service' %}
                  <span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span>
                {% elif order.type == 'sales' %}
                  <span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
                {% else %}
                  <span class="badge bg-secondary">{{ order.type }}</span>
                {% endif %}
              </p>
              <p class="mb-0"><strong>Progress:</strong> <span class="text-muted">Step 1 of 3</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Action Buttons -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-3 justify-content-center">
            <!-- Customer and Vehicle Info -->
            <div class="btn-group" role="group">
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('customer')">
                <i class="fa fa-user me-2"></i>Customer Info
              </button>
              {% if vehicle %}
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('vehicle')">
                <i class="fa fa-car me-2"></i>Vehicle Info
              </button>
              {% endif %}
            </div>

            <!-- Order Management -->
            <div class="btn-group" role="group">
              <button type="button" id="uploadInvoiceBtn" class="btn btn-primary">
                <i class="fa fa-file-upload me-2"></i>Upload Invoice
              </button>
              <button type="button" id="editOrderDetailsBtn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editOrderDetailsModal">
                <i class="fa fa-list me-2"></i>Edit Details
              </button>
            </div>

            <!-- Complete Order -->
            <button type="button" id="completeOrderBtn" class="btn btn-success">
              <i class="fa fa-check me-2"></i>Complete Order
            </button>
          </div>

          <!-- Overrun Reason Modal -->
          <div class="modal fade" id="overrunReasonModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                  <h5 class="modal-title">Order Overrun Reason</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <p class="mb-2">This service order has exceeded the expected time. Please provide a reason before completing.</p>
                  <div class="mb-3">
                    <label class="form-label">Reason</label>
                    <textarea id="overrunReasonInput" class="form-control" rows="4" placeholder="Explain why this order exceeded its ETA (required)"></textarea>
                    <div id="overrunReasonError" class="text-danger mt-2" style="display:none;"></div>
                  </div>
                </div>
                <div class="modal-footer bg-light">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" id="saveOverrunReasonBtn" class="btn btn-warning">Save & Continue to Complete</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Hybrid Invoice Modal (Upload + Manual Entry) -->
          <div class="modal fade" id="uploadInvoiceModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header bg-light border-bottom">
                  <h5 class="modal-title">
                    <i class="fa fa-file-invoice me-2"></i>Create Invoice for Order {{ order.order_number }}
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Quick Info Bar -->
                <div class="alert alert-info mb-0 border-0 rounded-0" role="alert">
                  <div class="d-flex align-items-center">
                    <i class="fa fa-lightbulb me-3" style="font-size: 18px;"></i>
                    <div>
                      <strong>Tip:</strong> Upload a PDF invoice to auto-extract data, or enter details manually below.
                    </div>
                  </div>
                </div>

                <!-- Nav Tabs -->
                <ul class="nav nav-tabs" role="tablist" style="border-bottom: 1px solid #dee2e6; margin: 0; padding: 10px 15px;">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="invoiceUploadTab" data-bs-toggle="tab" data-bs-target="#uploadTabPane" type="button" role="tab">
                      <i class="fa fa-upload me-2"></i>Upload PDF
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="invoiceManualTab" data-bs-toggle="tab" data-bs-target="#manualTabPane" type="button" role="tab">
                      <i class="fa fa-pencil me-2"></i>Enter Manually
                    </button>
                  </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                  <!-- Upload Tab -->
                  <div class="tab-pane fade show active" id="uploadTabPane" role="tabpanel">
                    <div class="modal-body">
                      <div class="alert alert-info mb-3">
                        <small><i class="fa fa-info-circle me-2"></i>Upload a PDF invoice. Text will be extracted and data auto-populated.</small>
                      </div>

                      <div class="mb-3">
                        <label class="form-label fw-bold">Select PDF File</label>
                        <input type="file" id="startedOrderInvoiceFile" class="form-control" accept=".pdf" data-max-file-size="50485760">
                        <small class="text-muted">PDF files only. Max 50MB.</small>
                      </div>

                      <div id="startedUploadError" class="alert alert-danger" style="display:none" role="alert"></div>
                      <div id="extractionSuccess" class="alert alert-success" style="display:none" role="alert">
                        <i class="fa fa-check-circle me-2"></i>Data extracted successfully! Switch to the <strong>Enter Manually</strong> tab to review and confirm the details.
                      </div>
                      <div id="startedUploadProgress" class="progress" style="display:none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="startedUploadProgressBar" role="progressbar" style="width: 0%"></div>
                      </div>

                      <div id="uploadedInvoicePreview" style="display:none;" class="card mt-3">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                          <strong><i class="fa fa-check-circle me-2 text-success"></i>Extracted Data Preview</strong>
                          <small class="text-muted">Review the extracted data below</small>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                          <!-- Customer Information -->
                          <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2"><i class="fa fa-user me-2"></i>Customer Information</h6>
                            <div class="row g-2">
                              <div class="col-md-6">
                                <small class="text-muted d-block">Name</small>
                                <p id="previewCustomerName" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Phone</small>
                                <p id="previewCustomerPhone" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Email</small>
                                <p id="previewCustomerEmail" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Address</small>
                                <p id="previewCustomerAddress" class="mb-0">-</p>
                              </div>
                            </div>
                          </div>

                          <!-- Invoice Information -->
                          <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2"><i class="fa fa-file-invoice me-2"></i>Invoice Information</h6>
                            <div class="row g-2">
                              <div class="col-md-6">
                                <small class="text-muted d-block">Invoice Number</small>
                                <p id="previewInvoiceNo" class="mb-0"><strong>-</strong></p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Code No</small>
                                <p id="previewCodeNo" class="mb-0"><strong>-</strong></p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">PI No</small>
                                <p id="previewPINO" class="mb-0"><strong>-</strong></p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Invoice Date</small>
                                <p id="previewInvoiceDate" class="mb-0"><strong>-</strong></p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Reference</small>
                                <p id="previewReference" class="mb-0">-</p>
                              </div>
                            </div>
                          </div>

                          <!-- Payment Information -->
                          <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-muted mb-2"><i class="fa fa-money me-2"></i>Payment Summary</h6>
                            <div class="row g-2">
                              <div class="col-md-6">
                                <small class="text-muted d-block">Subtotal</small>
                                <p id="previewSubtotal" class="mb-0">-</p>
                              </div>
                              <div class="col-md-6">
                                <small class="text-muted d-block">Tax/VAT</small>
                                <p id="previewTax" class="mb-0">-</p>
                              </div>
                              <div class="col-md-12">
                                <small class="text-muted d-block">Total Amount</small>
                                <p id="previewTotal" class="mb-0 fs-5"><strong>-</strong></p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 15px;">
                      <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                      <div style="flex: 1; text-align: center; margin: 0 15px;">
                        <p class="text-muted small mb-2">
                          <i class="fa fa-info-circle me-1"></i>
                          Can't find a PDF? No problem!
                        </p>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="skipUploadManualBtn" data-bs-toggle="tab" data-bs-target="#manualTabPane">
                          <i class="fa fa-pencil me-1"></i>Enter Manually Instead
                        </button>
                      </div>
                      <button type="button" id="startedUploadBtn" class="btn btn-primary btn-lg" style="min-width: 160px;">
                        <i class="fa fa-upload me-2"></i>Upload PDF
                      </button>
                    </div>
                  </div>

                  <!-- Manual Entry Tab -->
                  <div class="tab-pane fade" id="manualTabPane" role="tabpanel">
                    <!-- Workflow Guide -->
                    <div class="alert alert-primary alert-dismissible fade show mb-4" role="alert" style="border-left: 4px solid #0d6efd;">
                      <div class="d-flex align-items-start">
                        <i class="fa fa-check-circle me-3 mt-1" style="font-size: 24px; color: #0d6efd;"></i>
                        <div>
                          <h6 class="mb-2"><strong>Easy Steps to Create Invoice Manually</strong></h6>
                          <ol class="mb-0 ms-3 small">
                            <li class="mb-1"><strong>Customer Info:</strong> Enter customer name, phone, and type</li>
                            <li class="mb-1"><strong>Invoice Details:</strong> Add invoice number and date</li>
                            <li class="mb-1"><strong>Amount:</strong> Enter subtotal, tax, and total amount</li>
                            <li class="mb-1"><strong>Order Type:</strong> Select Service or Sales</li>
                            <li class="mb-1"><strong>Services/Items:</strong> Choose what was provided</li>
                            <li><strong>Submit:</strong> Click "Create Invoice" to finish</li>
                          </ol>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                      </div>
                    </div>

                    <!-- Step Indicator -->
                    <div class="manual-entry-steps mb-4">
                      <div class="row text-center g-2">
                        <div class="col-6 col-md-4">
                          <div class="step-badge active" data-step="1" style="padding: 15px; border-radius: 8px; border: 2px solid #0d6efd; background: #e7f1ff;">
                            <div class="step-number" style="font-size: 20px; font-weight: bold; color: #0d6efd;">1</div>
                            <div class="step-label" style="font-size: 12px; margin-top: 5px;">Customer</div>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="step-badge" data-step="2" style="padding: 15px; border-radius: 8px; border: 2px solid #dee2e6; background: #f8f9fa;">
                            <div class="step-number" style="font-size: 20px; font-weight: bold; color: #6c757d;">2</div>
                            <div class="step-label" style="font-size: 12px; margin-top: 5px;">Invoice</div>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="step-badge" data-step="3" style="padding: 15px; border-radius: 8px; border: 2px solid #dee2e6; background: #f8f9fa;">
                            <div class="step-number" style="font-size: 20px; font-weight: bold; color: #6c757d;">3</div>
                            <div class="step-label" style="font-size: 12px; margin-top: 5px;">Amount</div>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="step-badge" data-step="4" style="padding: 15px; border-radius: 8px; border: 2px solid #dee2e6; background: #f8f9fa;">
                            <div class="step-number" style="font-size: 20px; font-weight: bold; color: #6c757d;">4</div>
                            <div class="step-label" style="font-size: 12px; margin-top: 5px;">Type</div>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="step-badge" data-step="5" style="padding: 15px; border-radius: 8px; border: 2px solid #dee2e6; background: #f8f9fa;">
                            <div class="step-number" style="font-size: 20px; font-weight: bold; color: #6c757d;">5</div>
                            <div class="step-label" style="font-size: 12px; margin-top: 5px;">Services</div>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="step-badge" data-step="6" style="padding: 15px; border-radius: 8px; border: 2px solid #dee2e6; background: #f8f9fa;">
                            <div class="step-number" style="font-size: 20px; font-weight: bold; color: #6c757d;">âœ“</div>
                            <div class="step-label" style="font-size: 12px; margin-top: 5px;">Submit</div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <form id="manualInvoiceForm" method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="create_invoice_manual">
                      <input type="hidden" name="selected_order_id" value="{{ order.id }}">
                      {% if vehicle and vehicle.plate_number %}<input type="hidden" name="plate" value="{{ vehicle.plate_number }}">{% endif %}
                      
                      <!-- Hidden fields for additional details and attendee info -->
                      <input type="hidden" name="payment_method" id="hiddenPaymentMethod" value="">
                      <input type="hidden" name="delivery_terms" id="hiddenDeliveryTerms" value="">
                      <input type="hidden" name="attended_by" id="hiddenAttendedBy" value="">
                      <input type="hidden" name="kind_attention" id="hiddenKindAttention" value="">
                      <input type="hidden" name="remarks" id="hiddenRemarks" value="">
                      <input type="hidden" name="notes" id="hiddenNotes" value="">
                      
                      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <!-- Existing Customer Alert -->
                        <div id="existingCustomerAlert" class="alert alert-info alert-dismissible fade show" style="display:none;">
                          <i class="fa fa-info-circle me-2"></i>
                          <strong>Existing Customer Found!</strong> A customer with this phone number already exists in the database.
                          <span id="existingCustomerName"></span>
                          You can update the information if needed or just use the existing customer.
                          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- Customer Section -->
                        <div class="card mb-3">
                          <div class="card-header bg-light">
                            <strong><i class="fa fa-user me-2"></i>Customer Information</strong>
                          </div>
                          <div class="card-body">
                            <div class="row mb-2">
                              <div class="col-md-6">
                                <label class="form-label">Full Name *</label>
                                <input type="text" name="customer_name" class="form-control" id="manualCustomerName" value="{{ order.customer.full_name }}" placeholder="Customer full name" required>
                              </div>
                              <div class="col-md-6">
                                <label class="form-label">Phone *</label>
                                <input type="tel" name="customer_phone" class="form-control" id="manualCustomerPhone" placeholder="Phone number" required>
                              </div>
                            </div>
                            <div class="row mb-2">
                              <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" name="customer_email" class="form-control" placeholder="email@example.com">
                              </div>
                              <div class="col-md-6">
                                <label class="form-label">Customer Type *</label>
                                <select name="customer_type" id="invoiceCustomerType" class="form-select" required>
                                  <option value="">Select customer type</option>
                                  <option value="personal">Personal</option>
                                  <option value="company">Private Company</option>
                                  <option value="ngo">NGO</option>
                                  <option value="government">Government</option>
                                </select>
                              </div>
                            </div>
                            <div class="row mb-2" id="personalSubtypeWrapper" style="display:none;">
                              <div class="col-md-6">
                                <label class="form-label">Personal Subtype</label>
                                <select name="customer_personal_subtype" class="form-select">
                                  <option value="">Select subtype</option>
                                  <option value="owner">Owner</option>
                                  <option value="driver">Driver</option>
                                </select>
                              </div>
                            </div>
                            <div class="row mb-2">
                              <div class="col-md-12">
                                <label class="form-label">Address</label>
                                <input type="text" name="customer_address" class="form-control" placeholder="Customer address">
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Invoice Section -->
                        <div class="card mb-3">
                          <div class="card-header bg-light">
                            <strong><i class="fa fa-file-invoice me-2"></i>Invoice Information</strong>
                          </div>
                          <div class="card-body">
                            <div class="row mb-2">
                              <div class="col-md-6">
                                <label class="form-label fw-bold">Invoice Number</label>
                                <input type="text" name="invoice_number" class="form-control" placeholder="e.g., INV-001">
                              </div>
                              <div class="col-md-6">
                                <label class="form-label fw-bold">Invoice Date</label>
                                <input type="date" name="invoice_date" class="form-control" value="{% now 'Y-m-d' %}" required>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Payment Section -->
                        <div class="card mb-3">
                          <div class="card-header bg-light">
                            <strong><i class="fa fa-money me-2"></i>Payment Information</strong>
                          </div>
                          <div class="card-body">
                            <div class="row mb-2">
                              <div class="col-md-6">
                                <label class="form-label fw-bold">Subtotal</label>
                                <div class="input-group">
                                  <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                                  <input type="number" name="subtotal" class="form-control manual-amount" step="0.01" min="0" placeholder="0.00">
                                </div>
                              </div>
                              <div class="col-md-6">
                                <label class="form-label fw-bold">Tax/VAT</label>
                                <div class="input-group">
                                  <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                                  <input type="number" name="tax_amount" class="form-control manual-amount" step="0.01" min="0" placeholder="0.00">
                                </div>
                              </div>
                            </div>

                            <div class="row mb-2">
                              <div class="col-md-12">
                                <label class="form-label fw-bold">Total Amount *</label>
                                <div class="input-group">
                                  <span class="input-group-text">{{ order.branch.code|default:"TSH" }}</span>
                                  <input type="number" name="total_amount" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <hr>

                        <!-- Order Type Selection -->
                        <div class="mb-3">
                          <label class="form-label fw-bold">Order Type *</label>
                          <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check order-type-option" name="order_type" id="orderTypeService" value="service" required>
                            <label class="btn btn-outline-primary" for="orderTypeService">
                              <i class="fa fa-hammer me-2"></i>Service
                            </label>

                            <input type="radio" class="btn-check order-type-option" name="order_type" id="orderTypeSales" value="sales" required>
                            <label class="btn btn-outline-primary" for="orderTypeSales">
                              <i class="fa fa-shopping-bag me-2"></i>Sales
                            </label>
                          </div>
                        </div>

                        <!-- Service Order Type Section -->
                        <div id="serviceOrderSection" style="display:none;" class="mb-3">
                          <div class="card border-success">
                            <div class="card-header bg-success text-white">
                              <h6 class="mb-0"><i class="fa fa-list-check me-2"></i>Service Offered</h6>
                            </div>
                            <div class="card-body">
                              <div class="row g-2" id="serviceTypesContainer">
                                <!-- Service checkboxes will be loaded here -->
                              </div>
                              <div class="small text-muted mt-2" id="serviceEtaHint" style="display:none;"></div>
                            </div>
                          </div>
                        </div>

                        <!-- Sales Order Type Section -->
                        <div id="salesOrderSection" style="display:none;" class="mb-3">
                          <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                              <h6 class="mb-0"><i class="fa fa-list-check me-2"></i>Tire Service Add-ons</h6>
                            </div>
                            <div class="card-body">
                              <div class="row g-2" id="addonTypesContainer">
                                <!-- Addon checkboxes will be loaded here -->
                              </div>
                              <div class="small text-muted mt-2" id="addonEtaHint" style="display:none;"></div>
                            </div>
                          </div>
                        </div>

                        <!-- Hidden input to store selected services/addons -->
                        <input type="hidden" name="service_selection" id="serviceSelection" value="">
                        <input type="hidden" name="estimated_duration" id="estimatedDuration" value="">

                        <style>
                          .service-checkbox-card, .addon-checkbox-card {
                            padding: 12px;
                            border: 2px solid #e0e0e0;
                            border-radius: 8px;
                            transition: all 0.2s ease;
                            cursor: pointer;
                            height: 100%;
                            display: flex;
                            align-items: center;
                          }
                          .service-checkbox-card:hover, .addon-checkbox-card:hover {
                            background-color: #f8f9fa;
                            border-color: #0d6efd;
                          }
                          .service-checkbox-card input[type="checkbox"]:checked + .service-checkbox-label,
                          .addon-checkbox-card input[type="checkbox"]:checked + .addon-checkbox-label {
                            color: #0d6efd;
                            font-weight: 600;
                          }
                          .service-checkbox-card input[type="checkbox"]:checked,
                          .addon-checkbox-card input[type="checkbox"]:checked {
                            border-color: #0d6efd;
                            background-color: #0d6efd;
                          }
                          .service-checkbox-card input, .addon-checkbox-card input {
                            margin-right: 8px;
                            cursor: pointer;
                            flex-shrink: 0;
                          }
                          .service-checkbox-label, .addon-checkbox-label {
                            cursor: pointer;
                            margin: 0;
                            flex: 1;
                          }
                          .service-checkbox-content, .addon-checkbox-content {
                            width: 100%;
                          }
                          .service-checkbox-name, .addon-checkbox-name {
                            font-weight: 500;
                            margin-bottom: 4px;
                          }
                          .service-checkbox-duration, .addon-checkbox-duration {
                            font-size: 0.875rem;
                            color: #6c757d;
                          }
                        </style>
                      </div>
                      <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 20px; background: #f8f9fa;">
                        <div class="text-center w-100 mb-3">
                          <p class="text-muted small mb-0">
                            <i class="fa fa-info-circle me-1"></i>
                            Fill in the required fields above, then click the button below to create the invoice.
                          </p>
                        </div>
                        <div class="w-100 d-flex gap-2" style="margin-top: -15px;">
                          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fa fa-times me-2"></i>Cancel
                          </button>
                          <button type="submit" class="btn btn-success btn-lg flex-grow-1" style="font-weight: 600;">
                            <i class="fa fa-check-circle me-2"></i>Create Invoice
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Order Details Modal -->
          <div class="modal fade" id="editOrderDetailsModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fa fa-list me-2"></i>Edit Order Details</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="orderDetailsForm" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="update_order_details">
                  <div class="modal-body">
                    <!-- Item Selection for Sales Orders -->
                    <div id="itemSelectionSection" class="mb-3" style="display:none;">
                      <label class="form-label fw-bold">Select Item</label>
                      <select id="editOrderItemSelect" name="item_id" class="form-select mb-2">
                        <option value="">Loading items...</option>
                      </select>
                      <div class="row g-2">
                        <div class="col-md-6">
                          <label class="form-label">Brand</label>
                          <input type="text" id="editOrderBrand" name="item_brand" class="form-control" readonly>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Quantity</label>
                          <input type="number" id="editOrderQuantity" name="item_quantity" class="form-control" value="1" min="1">
                        </div>
                      </div>
                    </div>

                    <!-- Services/Add-ons Section -->
                    <div id="servicesAddonsSection" class="mb-3">
                      <label class="form-label fw-bold" id="editOrderOptionsLabel">Select Services</label>
                      <div id="orderServicesContainer" class="row g-2">Loading services...</div>
                      <div class="small text-muted mt-2" id="editOrderEtaHint" style="display:none;"></div>
                    </div>

                    <!-- Duration -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">Estimated Duration (minutes)</label>
                      <input type="number" name="estimated_duration" id="orderEstimatedDuration" class="form-control" value="{{ order.estimated_duration|default:'' }}" min="0">
                    </div>
                    <div class="mb-2 text-muted small" id="editOrderHelpText">Selected services will be appended to the order description for quick reference.</div>
                  </div>
                  <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <script>
            // Safe querySelectorAll function with null check
            function safeQuerySelectorAll(selector, context) {
              const element = context ? context.querySelectorAll(selector) : document.querySelectorAll(selector);
              return element || [];
            }

            // Populate options in Edit Order Details modal
            document.getElementById('editOrderDetailsBtn').addEventListener('click', function(){
              const container = document.getElementById('orderServicesContainer');
              const label = document.getElementById('editOrderOptionsLabel');
              const itemSection = document.getElementById('itemSelectionSection');
              const itemSelect = document.getElementById('editOrderItemSelect');
              const brandField = document.getElementById('editOrderBrand');
              const helpText = document.getElementById('editOrderHelpText');
              const helpSalesText = 'Selected item and add-ons will be saved to the order. Add-ons will be appended to the order description.';
              const helpServiceText = 'Selected services will be appended to the order description for quick reference.';

              if (!container) {
                console.error('orderServicesContainer not found');
                return;
              }

              container.innerHTML = 'Loading...';
              fetch('{% url "tracker:api_service_types" %}', {
                method: 'GET',
                headers: {
                  'X-CSRFToken': getCSRFToken() || '',
                  'X-Requested-With': 'XMLHttpRequest'
                }
              })
              .then(r => {
                if (!r.ok) {
                  console.error('API response not ok:', r.status, r.statusText);
                  throw new Error('API request failed');
                }
                return r.json();
              })
              .then(data => {
                console.log('API response data:', data);
                container.innerHTML = '';
                const existingDesc = `{{ order.description|default:'' }}`.toLowerCase();
                const orderType = ('{{ order.type|default:'' }}').toLowerCase();
                const serviceTypes = Array.isArray(data.service_types) ? data.service_types : [];
                const addOns = Array.isArray(data.service_addons) ? data.service_addons : [];
                const inventoryItems = Array.isArray(data.inventory_items) ? data.inventory_items : [];
                console.log('Inventory items loaded:', inventoryItems.length, inventoryItems);

                function renderCheckbox(name, mins, isChecked, extraBadge){
                  const safe = (name||'').replace(/[^A-Za-z0-9_]/g,'_');
                  const id = 'od_opt_' + safe;
                  const col = document.createElement('div'); 
                  col.className = 'col-md-6';
                  const badge = extraBadge ? ` <span class="badge bg-light text-dark ms-1">${extraBadge}</span>` : '';
                  col.innerHTML = `<div class="form-check">
                    <input class="form-check-input od-option" type="checkbox" id="${id}" name="services" value="${name}" data-minutes="${mins||0}" ${isChecked?'checked':''}>
                    <label class="form-check-label" for="${id}">${name} <span class="text-muted small">(${mins||0}m)</span>${badge}</label>
                  </div>`;
                  container.appendChild(col);
                }

                if (orderType === 'sales') {
                  // Show item selection for sales orders
                  if (itemSection) itemSection.style.display = 'block';
                  if (label) label.textContent = 'Select Add-ons';
                  if (helpText) helpText.textContent = helpSalesText;

                  // Populate item selection
                  if (itemSelect) {
                    itemSelect.innerHTML = '<option value="">Select item</option>';
                    if (inventoryItems.length > 0) {
                      console.log('Adding', inventoryItems.length, 'items to dropdown');
                      inventoryItems.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.brand} - ${item.name}`;
                        option.setAttribute('data-brand', item.brand);
                        itemSelect.appendChild(option);
                      });
                    } else {
                      console.warn('No inventory items available');
                      itemSelect.innerHTML += '<option value="" disabled>No items available</option>';
                    }

                    // Set existing item if available
                    const existingItem = ('{{ order.item_name|default:"" }}').trim();
                    const existingBrand = ('{{ order.brand|default:"" }}').trim();
                    console.log('Existing item:', existingItem, 'Brand:', existingBrand);
                    if (existingItem && inventoryItems.length > 0) {
                      const selectedItem = inventoryItems.find(i => i.name === existingItem && i.brand === existingBrand);
                      if (selectedItem && brandField) {
                        console.log('Setting selected item:', selectedItem);
                        itemSelect.value = selectedItem.id;
                        brandField.value = selectedItem.brand;
                      }
                    }

                    // Handle item selection change
                    itemSelect.addEventListener('change', function(){
                      console.log('Item selection changed:', this.value);
                      if (this.value && brandField) {
                        const selectedItem = inventoryItems.find(i => i.id === parseInt(this.value));
                        console.log('Selected item found:', selectedItem);
                        if (selectedItem) {
                          console.log('Setting brand field to:', selectedItem.brand);
                          brandField.value = selectedItem.brand;
                        }
                      } else if (brandField) {
                        console.log('Clearing brand field');
                        brandField.value = '';
                      }
                    });
                  }

                  // Show add-ons for sales
                  if (addOns.length) {
                    addOns.forEach(add => {
                      const checked = existingDesc.indexOf((add.name||'').toLowerCase()) !== -1;
                      renderCheckbox(add.name, add.estimated_minutes||0, checked, 'Addon');
                    });
                  } else {
                    container.innerHTML = '<div class="text-muted">No add-ons available</div>';
                  }
                } else {
                  // Hide item selection for service/inquiry orders
                  if (itemSection) itemSection.style.display = 'none';
                  if (label) label.textContent = 'Select Services';
                  if (helpText) helpText.textContent = helpServiceText;

                  if (serviceTypes.length) {
                    serviceTypes.forEach(svc => {
                      const checked = existingDesc.indexOf((svc.name||'').toLowerCase()) !== -1;
                      renderCheckbox(svc.name, svc.estimated_minutes||0, checked, '');
                    });
                  } else {
                    container.innerHTML = '<div class="text-muted">No services available</div>';
                  }
                  // Also show add-ons below services if present
                  if (addOns.length) {
                    const hr = document.createElement('div'); 
                    hr.className = 'col-12 mt-2'; 
                    hr.innerHTML = '<hr>'; 
                    container.appendChild(hr);
                    addOns.forEach(add => {
                      const checked = existingDesc.indexOf((add.name||'').toLowerCase()) !== -1;
                      renderCheckbox(add.name, add.estimated_minutes||0, checked, 'Addon');
                    });
                  }
                }

                // Wait for DOM to be updated before attaching event listeners
                setTimeout(() => {
                  // Attach change listeners for ETA using safe function
                  const optionElements = safeQuerySelectorAll('.od-option', container);
                  if (optionElements.length > 0) {
                    optionElements.forEach(cb => cb.addEventListener('change', updateEditOrderEta));
                  }
                  // Initialize ETA after elements are rendered
                  updateEditOrderEta();
                }, 100);

              })
              .catch(err => {
                console.error('Failed to fetch API:', err);
                if (container) container.innerHTML = '<div class="text-danger">Failed to load options</div>';
              });
            });

            // Fixed updateEditOrderEta function with null checks
            function updateEditOrderEta(){
              const hint = document.getElementById('editOrderEtaHint');
              const etaInput = document.getElementById('orderEstimatedDuration');
              let total = 0;
              
              // Safely get checkboxes
              const container = document.getElementById('orderServicesContainer');
              if (!container) return;
              
              const checkedOptions = safeQuerySelectorAll('.od-option:checked', container);
              if (checkedOptions.length > 0) {
                checkedOptions.forEach(cb => {
                  const m = parseInt(cb.getAttribute('data-minutes')||'0',10); 
                  if(!isNaN(m)) total += m;
                });
              }
              
              if (etaInput) { 
                etaInput.value = total > 0 ? String(total) : (etaInput.value || ''); 
              }
              
              if (hint){
                if (total > 0){ 
                  hint.style.display='block'; 
                  hint.textContent = 'Estimated total time: ' + total + ' mins'; 
                } else { 
                  hint.style.display='none'; 
                  hint.textContent=''; 
                }
              }
            }
          </script>

          <script>
            // Hybrid Invoice Modal Handler (Upload + Manual Entry)
            document.addEventListener('DOMContentLoaded', function(){
              // ===== DOM Elements =====
              const uploadBtn = document.getElementById('uploadInvoiceBtn');
              const modalEl = document.getElementById('uploadInvoiceModal');
              const modal = modalEl ? new bootstrap.Modal(modalEl) : null;

              // Upload Tab elements
              const fileInput = document.getElementById('startedOrderInvoiceFile');
              const startedUploadBtn = document.getElementById('startedUploadBtn');
              const startedUploadError = document.getElementById('startedUploadError');
              const extractionSuccess = document.getElementById('extractionSuccess');
              const uploadProgress = document.getElementById('startedUploadProgress');
              const uploadProgressBar = document.getElementById('startedUploadProgressBar');
              const uploadedInvoicePreview = document.getElementById('uploadedInvoicePreview');

              // Manual Entry Tab elements
              const manualForm = document.getElementById('manualInvoiceForm');
              const manualTab = document.getElementById('invoiceManualTab');
              const manualCustomerPhone = document.getElementById('manualCustomerPhone');
              const existingCustomerAlert = document.getElementById('existingCustomerAlert');
              const existingCustomerName = document.getElementById('existingCustomerName');

              // Storage for extracted data
              let extractedInvoiceData = null;

              // ===== Customer Existence Check =====
              function checkExistingCustomer(phone){
                if (!phone || phone.length < 5) {
                  if (existingCustomerAlert) existingCustomerAlert.style.display = 'none';
                  return;
                }

                fetch('/api/customers/check-exists/?phone=' + encodeURIComponent(phone), {
                  headers: {'X-Requested-With': 'XMLHttpRequest'}
                })
                .then(r => r.json())
                .then(data => {
                  if (data.exists && data.customer) {
                    if (existingCustomerAlert && existingCustomerName) {
                      existingCustomerAlert.style.display = 'block';
                      existingCustomerName.textContent = '<strong>' + escapeHtml(data.customer.full_name) + '</strong>';
                    }
                  } else {
                    if (existingCustomerAlert) existingCustomerAlert.style.display = 'none';
                  }
                })
                .catch(err => {
                  console.debug('Error checking customer existence:', err);
                });
              }

              function escapeHtml(text){
                if(!text) return '';
                const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
                return text.replace(/[&<>"']/g, function(m){ return map[m]; });
              }

              // Add change event listener to manual customer phone input
              if (manualCustomerPhone) {
                manualCustomerPhone.addEventListener('change', function(){
                  checkExistingCustomer(this.value);
                });
              }

              // Check when switching to manual tab
              if (manualTab) {
                manualTab.addEventListener('click', function(){
                  setTimeout(() => {
                    if (manualCustomerPhone) {
                      checkExistingCustomer(manualCustomerPhone.value);
                    }
                  }, 100);
                });
              }

              // ===== Utility Functions =====
              function getCSRF(){
                // Use global getCSRFToken() helper from csrf_helper.js
                return getCSRFToken() || '';
              }

              function showError(message, isDanger = true){
                if (startedUploadError) {
                  startedUploadError.style.display = 'block';
                  startedUploadError.innerHTML = message;
                  startedUploadError.className = isDanger ? 'alert alert-danger' : 'alert alert-warning';
                }
                if (extractionSuccess) extractionSuccess.style.display = 'none';
              }

              function showSuccess(message, isDanger = false){
                if (extractionSuccess) {
                  extractionSuccess.style.display = 'block';
                  extractionSuccess.innerHTML = message;
                }
                if (startedUploadError) startedUploadError.style.display = 'none';
              }

              function resetForm(){
                if (fileInput) fileInput.value = '';
                if (startedUploadError) startedUploadError.style.display = 'none';
                if (extractionSuccess) extractionSuccess.style.display = 'none';
                if (uploadProgress) uploadProgress.style.display = 'none';
                if (uploadedInvoicePreview) uploadedInvoicePreview.style.display = 'none';
                extractedInvoiceData = null;
              }

              // Function to clean customer name specifically
              function cleanCustomerName(customerName) {
                if (!customerName) return '';
                
                let cleaned = customerName.trim();
                
                // Remove common prefixes and suffixes
                const patterns = [
                  /^customer\s*name\s*[:]?\s*/i,
                  /^customer\s*[:]?\s*/i,
                  /^name\s*[:]?\s*/i,
                  /^client\s*name\s*[:]?\s*/i,
                  /^client\s*[:]?\s*/i,
                  /^company\s*name\s*[:]?\s*/i,
                  /^company\s*[:]?\s*/i,
                  /\s*customer\s*name\s*$/i,
                  /\s*customer\s*$/i,
                  /\s*name\s*$/i,
                  /\s*client\s*name\s*$/i,
                  /\s*client\s*$/i,
                  /\s*company\s*name\s*$/i,
                  /\s*company\s*$/i
                ];
                
                patterns.forEach(pattern => {
                  cleaned = cleaned.replace(pattern, '');
                });
                
                // Clean up any remaining colons and extra spaces
                cleaned = cleaned.replace(/^[:]\s*/, '').replace(/\s*[:]$/, '');
                cleaned = cleaned.replace(/\s+/g, ' ').trim();
                
                return cleaned;
              }

              // Function to clean the extracted header data
              function cleanExtractedHeader(header) {
                if (!header) return {};
                
                const cleanedHeader = {...header};
                
                // Clean customer name
                if (cleanedHeader.customer_name) {
                  cleanedHeader.customer_name = cleanCustomerName(cleanedHeader.customer_name);
                }
                
                // Clean phone number (remove labels like "Phone:", "Tel:", etc.)
                if (cleanedHeader.phone) {
                  cleanedHeader.phone = cleanedHeader.phone.replace(/^(phone|tel|telephone|mobile|cell)[\s:]*/i, '').trim();
                }
                
                // Clean email (remove labels like "Email:", "E-mail:", etc.)
                if (cleanedHeader.email) {
                  cleanedHeader.email = cleanedHeader.email.replace(/^(email|e-mail|mail)[\s:]*/i, '').trim();
                }
                
                // Clean address (remove labels like "Address:", "Location:", etc.)
                if (cleanedHeader.address) {
                  cleanedHeader.address = cleanedHeader.address.replace(/^(address|location|addr)[\s:]*/i, '').trim();
                }
                
                // Clean invoice number (remove labels like "Invoice No:", "Invoice #", etc.)
                if (cleanedHeader.invoice_no) {
                  cleanedHeader.invoice_no = cleanedHeader.invoice_no.replace(/^(invoice\s*(no|number|#)?[\s:]*)/i, '').trim();
                }
                
                return cleanedHeader;
              }

              // Safe querySelectorAll function
              function safeQuerySelectorAll(selector, context) {
                try {
                  const element = context ? context.querySelectorAll(selector) : document.querySelectorAll(selector);
                  return element || [];
                } catch (error) {
                  console.error('Error in safeQuerySelectorAll:', error);
                  return [];
                }
              }

              // ===== Modal Open Handler =====
              if (uploadBtn){
                uploadBtn.addEventListener('click', function(){
                  resetForm();
                  if (modal) modal.show();
                });
              }

              // ===== Upload Tab Handlers =====
              if (startedUploadBtn){
                startedUploadBtn.addEventListener('click', async function(){
                  if (startedUploadError) startedUploadError.style.display = 'none';
                  if (extractionSuccess) extractionSuccess.style.display = 'none';

                  // Validate file selection
                  if (!fileInput || !fileInput.files || !fileInput.files[0]){
                    showError('<i class="fa fa-warning me-2"></i>Please select a PDF file to upload.');
                    return;
                  }

                  const file = fileInput.files[0];
                  const maxSizeMB = 50;
                  const maxSizeBytes = maxSizeMB * 1024 * 1024;

                  if (file.size > maxSizeBytes){
                    showError(`<i class="fa fa-warning me-2"></i>File is too large. Maximum size is ${maxSizeMB}MB.`);
                    return;
                  }

                  if (!file.name.toLowerCase().endsWith('.pdf')){
                    showError('<i class="fa fa-warning me-2"></i>Please upload a PDF file (images are not supported).', false);
                    return;
                  }

                  // Build form data
                  const fd = new FormData();
                  fd.append('file', file);
                  fd.append('selected_order_id', '{{ order.id }}');

                  {% if vehicle and vehicle.plate_number %}
                  fd.append('plate', '{{ vehicle.plate_number }}');
                  {% endif %}

                  // Show loading state
                  startedUploadBtn.disabled = true;
                  if (uploadProgress) {
                    uploadProgress.style.display = 'block';
                    if (uploadProgressBar) uploadProgressBar.style.width = '50%';
                  }
                  const originalBtnText = startedUploadBtn.innerHTML;
                  startedUploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Extracting...';

                  try {
                    // Step 1: Extract preview data
                    const extractResponse = await fetch('{% url "tracker:api_extract_invoice_preview" %}', {
                      method: 'POST',
                      body: fd,
                      headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRF()
                      }
                    });

                    if (uploadProgressBar) uploadProgressBar.style.width = '100%';
                    const extractData = await extractResponse.json();

                    if (!extractData.success){
                      if (uploadProgress) uploadProgress.style.display = 'none';
                      const errorMsg = extractData.message || 'Could not extract data from PDF.';
                      showError(`
                        <div>
                          <i class="fa fa-warning me-2"></i><strong>PDF could not be processed</strong>
                          <p class="small mt-2 mb-0">${errorMsg}</p>
                          <p class="small mt-2 mb-0">No worries! You can <button type="button" class="btn btn-link btn-sm p-0" id="switchToManualBtn" data-bs-toggle="tab" data-bs-target="#manualTabPane" onclick="document.getElementById('invoiceManualTab').click(); return false;"><strong>enter the details manually</strong></button> instead.</p>
                        </div>
                      `, false);

                      // Add click handler for the manual button
                      const switchBtn = document.getElementById('switchToManualBtn');
                      if (switchBtn) {
                        switchBtn.addEventListener('click', function() {
                          const manualTab = document.getElementById('invoiceManualTab');
                          if (manualTab) {
                            const tab = new bootstrap.Tab(manualTab);
                            tab.show();
                          }
                        });
                      }
                      return;
                    }

                    // Clean the extracted data before using it
                    if (extractData.header) {
                      extractData.header = cleanExtractedHeader(extractData.header);
                    }

                    // Extraction successful - populate and show form
                    extractedInvoiceData = extractData;
                    populateManualFormWithExtracted(extractData);
                    showExtractedDataPreview(extractData.header, extractData.items);
                    if (uploadProgress) uploadProgress.style.display = 'none';
                    if (uploadProgressBar) uploadProgressBar.style.width = '0%';

                    // Show success message and preview
                    showSuccess('Invoice data extracted successfully! Switch to the <strong>Enter Manually</strong> tab to review and confirm the details.');
                    if (uploadedInvoicePreview) uploadedInvoicePreview.style.display = 'block';

                  } catch (err){
                    console.error('Upload error:', err);
                    if (uploadProgress) uploadProgress.style.display = 'none';
                    showError(`<i class="fa fa-exclamation-circle me-2"></i>Upload error: ${err && err.message ? err.message : 'Unknown error'}`);
                  } finally {
                    startedUploadBtn.disabled = false;
                    startedUploadBtn.innerHTML = originalBtnText;
                  }
                });
              }

              function showExtractedDataPreview(header, items){
                console.log('Showing extracted data preview:', header);
                
                // Customer Information
                const el1 = document.getElementById('previewCustomerName');
                if (el1) el1.textContent = header.customer_name || '-';

                const el2 = document.getElementById('previewCustomerPhone');
                if (el2) el2.textContent = header.phone || '-';

                const el3 = document.getElementById('previewCustomerEmail');
                if (el3) el3.textContent = header.email || '-';

                const el4 = document.getElementById('previewCustomerAddress');
                if (el4) el4.textContent = header.address || '-';

                // Invoice Information
                const el5 = document.getElementById('previewInvoiceNo');
                if (el5) el5.textContent = header.invoice_no || '-';

                const el6 = document.getElementById('previewCodeNo');
                if (el6) el6.textContent = header.code_no || '-';

                const el7 = document.getElementById('previewPINO');
                if (el7) el7.textContent = header.pi_no || header.invoice_no || '-';

                const el8 = document.getElementById('previewInvoiceDate');
                if (el8) el8.textContent = header.date || '-';

                const el9 = document.getElementById('previewReference');
                if (el9) el9.textContent = header.reference || '-';

                // Payment Information
                const el10 = document.getElementById('previewSubtotal');
                if (el10) el10.textContent = (header.subtotal || 0).toLocaleString();

                const el11 = document.getElementById('previewTax');
                if (el11) el11.textContent = (header.tax || 0).toLocaleString();

                const el12 = document.getElementById('previewTotal');
                if (el12) el12.textContent = (header.total || 0).toLocaleString();

                if (uploadedInvoicePreview) uploadedInvoicePreview.style.display = 'block';
              }

              function populateManualFormWithExtracted(data){
                const header = data.header || {};
                console.log('Populating manual form with:', header);
                
                if (manualForm){
                  // Populate customer fields
                  const customerNameField = manualForm.querySelector('input[name="customer_name"]');
                  if (customerNameField) customerNameField.value = header.customer_name || '';

                  const customerPhoneField = manualForm.querySelector('input[name="customer_phone"]');
                  if (customerPhoneField) customerPhoneField.value = header.phone || '';

                  const customerEmailField = manualForm.querySelector('input[name="customer_email"]');
                  if (customerEmailField) customerEmailField.value = header.email || '';

                  const customerAddressField = manualForm.querySelector('input[name="customer_address"]');
                  if (customerAddressField) customerAddressField.value = header.address || '';

                  // Populate customer type (default to personal if not specified)
                  const customerTypeField = manualForm.querySelector('select[name="customer_type"]');
                  if (customerTypeField) {
                    customerTypeField.value = header.customer_type || 'personal';
                    // Trigger change event to update subtype visibility
                    customerTypeField.dispatchEvent(new Event('change'));
                  }

                  // Populate invoice fields
                  const invoiceNumberField = manualForm.querySelector('input[name="invoice_number"]');
                  if (invoiceNumberField) invoiceNumberField.value = header.invoice_no || header.code_no || '';

                  // Handle invoice_date - convert from dd/mm/yyyy to yyyy-mm-dd for HTML date input
                  let invoiceDateValue = '';
                  if (header.date) {
                    const dateMatch = String(header.date).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                    if (dateMatch) {
                      invoiceDateValue = dateMatch[3] + '-' + String(dateMatch[2]).padStart(2, '0') + '-' + String(dateMatch[1]).padStart(2, '0');
                    } else {
                      invoiceDateValue = header.date;
                    }
                  }
                  const invoiceDateField = manualForm.querySelector('input[name="invoice_date"]');
                  if (invoiceDateField) invoiceDateField.value = invoiceDateValue;

                  const subtotalField = manualForm.querySelector('input[name="subtotal"]');
                  if (subtotalField) subtotalField.value = header.subtotal || '';

                  const taxField = manualForm.querySelector('input[name="tax_amount"]');
                  if (taxField) taxField.value = header.tax || '';

                  const totalField = manualForm.querySelector('input[name="total_amount"]');
                  if (totalField) totalField.value = header.total || '';

                  // Populate hidden fields for additional data
                  const paymentField = document.getElementById('hiddenPaymentMethod');
                  if (paymentField) paymentField.value = header.payment_method || '';

                  const deliveryField = document.getElementById('hiddenDeliveryTerms');
                  if (deliveryField) deliveryField.value = header.delivery_terms || '';

                  const attendedField = document.getElementById('hiddenAttendedBy');
                  if (attendedField) attendedField.value = header.attended_by || '';

                  const kindAttnField = document.getElementById('hiddenKindAttention');
                  if (kindAttnField) kindAttnField.value = header.kind_attention || '';

                  const remarksField = document.getElementById('hiddenRemarks');
                  if (remarksField) remarksField.value = header.remarks || '';

                  const notesField = document.getElementById('hiddenNotes');
                  if (notesField) notesField.value = header.notes || '';
                }
              }

              // ===== Customer Type Toggle =====
              const customerTypeEl = document.getElementById('invoiceCustomerType');
              const personalSubtypeWrapper = document.getElementById('personalSubtypeWrapper');
              if (customerTypeEl){
                function updateSubtypeVisibility(){
                  if (customerTypeEl.value === 'personal'){
                    if (personalSubtypeWrapper) personalSubtypeWrapper.style.display = 'block';
                  } else {
                    if (personalSubtypeWrapper) personalSubtypeWrapper.style.display = 'none';
                  }
                }
                customerTypeEl.addEventListener('change', updateSubtypeVisibility);
                updateSubtypeVisibility();
              }

              // ===== Order Type Selection and Service/Addon Loading =====
              const orderTypeOptions = safeQuerySelectorAll('.order-type-option');
              const serviceOrderSection = document.getElementById('serviceOrderSection');
              const salesOrderSection = document.getElementById('salesOrderSection');
              const serviceTypesContainer = document.getElementById('serviceTypesContainer');
              const addonTypesContainer = document.getElementById('addonTypesContainer');
              const serviceEtaHint = document.getElementById('serviceEtaHint');
              const addonEtaHint = document.getElementById('addonEtaHint');

              let serviceTypes = [];
              let addons = [];

              // Load service types and addons from API
              async function loadServiceData(){
                try {
                  const response = await fetch('{% url "tracker:api_service_types" %}', {
                    headers: {'X-Requested-With': 'XMLHttpRequest'}
                  });
                  const data = await response.json();
                  serviceTypes = data.service_types || [];
                  addons = data.service_addons || [];
                  renderServiceCheckboxes();
                  renderAddonCheckboxes();
                } catch (err){
                  console.error('Error loading service data:', err);
                }
              }

              function renderServiceCheckboxes(){
                if (!serviceTypesContainer) return;
                serviceTypesContainer.innerHTML = '';
                serviceTypes.forEach((svc, idx) => {
                  const col = document.createElement('div');
                  col.className = 'col-md-6 col-lg-4';
                  col.innerHTML = `
                    <div class="service-checkbox-card">
                      <input class="form-check-input service-checkbox" type="checkbox" id="svc_chk_${idx}" name="service_selection_chk" value="${svc.name}" data-minutes="${svc.estimated_minutes}">
                      <label class="service-checkbox-label" for="svc_chk_${idx}">
                        <div class="service-checkbox-content">
                          <div class="service-checkbox-name">${svc.name}</div>
                          <div class="service-checkbox-duration"><i class="fa fa-clock-o me-1"></i>${svc.estimated_minutes} mins</div>
                        </div>
                      </label>
                    </div>
                  `;
                  serviceTypesContainer.appendChild(col);
                });
                updateServiceEta();
              }

              function renderAddonCheckboxes(){
                if (!addonTypesContainer) return;
                addonTypesContainer.innerHTML = '';
                addons.forEach((addon, idx) => {
                  const col = document.createElement('div');
                  col.className = 'col-md-6 col-lg-4';
                  col.innerHTML = `
                    <div class="addon-checkbox-card">
                      <input class="form-check-input addon-checkbox" type="checkbox" id="addon_chk_${idx}" name="tire_services_chk" value="${addon.name}" data-minutes="${addon.estimated_minutes}">
                      <label class="addon-checkbox-label" for="addon_chk_${idx}">
                        <div class="addon-checkbox-content">
                          <div class="addon-checkbox-name">${addon.name}</div>
                          <div class="addon-checkbox-duration"><i class="fa fa-clock-o me-1"></i>${addon.estimated_minutes} mins</div>
                        </div>
                      </label>
                    </div>
                  `;
                  addonTypesContainer.appendChild(col);
                });
                updateAddonEta();
              }

              function updateServiceEta(){
                if (!serviceTypesContainer) return;
                const checked = safeQuerySelectorAll('.service-checkbox:checked', serviceTypesContainer);
                let totalMinutes = 0;
                checked.forEach(chk => {
                  totalMinutes += parseInt(chk.dataset.minutes || 0);
                });
                const serviceSelection = Array.from(checked).map(c => c.value).join(',');
                const serviceSelInput = document.getElementById('serviceSelection');
                const estimatedDurInput = document.getElementById('estimatedDuration');
                if (serviceSelInput) serviceSelInput.value = serviceSelection;
                if (estimatedDurInput) estimatedDurInput.value = totalMinutes;
                if (serviceEtaHint){
                  if (totalMinutes > 0){
                    serviceEtaHint.textContent = `Estimated duration: ${totalMinutes} minutes`;
                    serviceEtaHint.style.display = 'block';
                  } else {
                    serviceEtaHint.style.display = 'none';
                  }
                }
              }

              function updateAddonEta(){
                if (!addonTypesContainer) return;
                const checked = safeQuerySelectorAll('.addon-checkbox:checked', addonTypesContainer);
                let totalMinutes = 0;
                checked.forEach(chk => {
                  totalMinutes += parseInt(chk.dataset.minutes || 0);
                });
                const addonSelection = Array.from(checked).map(c => c.value).join(',');
                const serviceSelInput = document.getElementById('serviceSelection');
                const estimatedDurInput = document.getElementById('estimatedDuration');
                if (serviceSelInput) serviceSelInput.value = addonSelection;
                if (estimatedDurInput) estimatedDurInput.value = totalMinutes;
                if (addonEtaHint){
                  if (totalMinutes > 0){
                    addonEtaHint.textContent = `Estimated duration: ${totalMinutes} minutes`;
                    addonEtaHint.style.display = 'block';
                  } else {
                    addonEtaHint.style.display = 'none';
                  }
                }
              }

              if (orderTypeOptions && orderTypeOptions.length > 0){
                orderTypeOptions.forEach(option => {
                  option.addEventListener('change', function(){
                    if (this.value === 'service'){
                      if (serviceOrderSection) serviceOrderSection.style.display = 'block';
                      if (salesOrderSection) salesOrderSection.style.display = 'none';
                    } else {
                      if (serviceOrderSection) serviceOrderSection.style.display = 'none';
                      if (salesOrderSection) salesOrderSection.style.display = 'block';
                    }
                  });
                });
              }

              // Attach listeners to service/addon checkboxes
              if (serviceTypesContainer){
                serviceTypesContainer.addEventListener('change', updateServiceEta);
              }
              if (addonTypesContainer){
                addonTypesContainer.addEventListener('change', updateAddonEta);
              }

              // Load service data on modal open
              if (serviceTypesContainer || addonTypesContainer){
                loadServiceData();
              }

              // Handle manual form submission
              if (manualForm){
                manualForm.addEventListener('submit', async function(e){
                  e.preventDefault();

                  // Validate required fields
                  const customerName = this.querySelector('input[name="customer_name"]');
                  const customerPhone = this.querySelector('input[name="customer_phone"]');
                  const customerType = this.querySelector('select[name="customer_type"]');
                  const totalAmount = this.querySelector('input[name="total_amount"]');
                  const orderType = this.querySelector('input[name="order_type"]:checked');

                  if (!customerName || !customerName.value.trim() || 
                      !customerPhone || !customerPhone.value.trim() || 
                      !customerType || !customerType.value.trim() || 
                      !totalAmount || !totalAmount.value.trim()){
                    showError('<i class="fa fa-warning me-2"></i>Please fill in customer name, phone, customer type, and total amount.');
                    return;
                  }

                  if (!orderType){
                    showError('<i class="fa fa-warning me-2"></i>Please select an order type (Service or Sales).');
                    return;
                  }

                  const fd = new FormData(this);
                  // Include the originally uploaded file so backend can store it on the Invoice
                  if (typeof fileInput !== 'undefined' && fileInput && fileInput.files && fileInput.files[0]){
                    fd.append('file', fileInput.files[0]);
                  }

                  // Show loading state
                  const submitBtn = this.querySelector('button[type="submit"]');
                  const originalBtnText = submitBtn.innerHTML;
                  submitBtn.disabled = true;
                  if (uploadProgress) {
                    uploadProgress.style.display = 'block';
                    if (uploadProgressBar) uploadProgressBar.style.width = '50%';
                  }

                  try {
                    // Call the create-from-upload API endpoint
                    const response = await fetch('{% url "tracker:api_create_invoice_from_upload" %}', {
                      method: 'POST',
                      body: fd,
                      headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRF()
                      }
                    });

                    if (uploadProgressBar) uploadProgressBar.style.width = '100%';
                    const result = await response.json();

                    if (result.success){
                      showSuccess('<i class="fa fa-check-circle me-2"></i>Invoice created successfully! Redirecting...', false);
                      setTimeout(function(){
                        window.location.href = result.redirect_url || ('/tracker/invoices/' + result.invoice_id + '/');
                      }, 1000);
                    } else {
                      showError(`<i class="fa fa-exclamation-circle me-2"></i>${result.message || 'Failed to create invoice'}`);
                      if (uploadProgress) uploadProgress.style.display = 'none';
                      if (uploadProgressBar) uploadProgressBar.style.width = '0%';
                    }
                  } catch (err){
                    console.error('Form submission error:', err);
                    showError(`<i class="fa fa-exclamation-circle me-2"></i>Error: ${err.message}`);
                    if (uploadProgress) uploadProgress.style.display = 'none';
                    if (uploadProgressBar) uploadProgressBar.style.width = '0%';
                  } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                  }
                });
              }

              // Reset form when modal closes
              if (modalEl){
                modalEl.addEventListener('hidden.bs.modal', function(){
                  resetForm();
                });
              }
            });
          </script>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="fa fa-eye me-2"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
        <i class="fa fa-file me-2"></i>Documents <span class="badge bg-danger ms-1">{{ documents.count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
        <i class="fa fa-list me-2"></i>Order Details
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
            </div>
            <div class="card-body">
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Name</small>
                  <strong>{{ customer.full_name }}</strong>
                </div>
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Phone</small>
                  <strong><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></strong>
                </div>
                {% if customer.email %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Email</small>
                  <strong><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></strong>
                </div>
                {% endif %}
                {% if customer.address %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Address</small>
                  <strong>{{ customer.address }}</strong>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-car me-2"></i>Vehicle Information</h6>
            </div>
            <div class="card-body">
              {% if vehicle %}
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Plate Number</small>
                  <strong>{{ vehicle.plate_number }}</strong>
                </div>
                {% if vehicle.make %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Make</small>
                  <strong>{{ vehicle.make }}</strong>
                </div>
                {% endif %}
                {% if vehicle.model %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Model</small>
                  <strong>{{ vehicle.model }}</strong>
                </div>
                {% endif %}
                {% if vehicle.vehicle_type %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Type</small>
                  <strong>{{ vehicle.vehicle_type }}</strong>
                </div>
                {% endif %}
              </div>
              {% else %}
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-exclamation-triangle me-2"></i>No vehicle information
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents">
      <!-- Document Upload Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-cloud-upload me-2"></i>Upload Invoice/Document</h6>
        </div>
        <div class="card-body">
          <form id="documentUploadForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label">Select Document (PDF preferred)</label>
              <div class="input-group">
                <input type="file" id="documentUploadInput" name="document" accept=".pdf,.txt,.png,.jpg,.jpeg" class="form-control" required>
                <button class="btn btn-primary" type="button" id="uploadDocumentBtn" onclick="uploadDocument()">
                  <i class="fa fa-upload me-1"></i>Upload & Extract
                </button>
              </div>
              <small class="text-muted d-block mt-2">Supported formats: PDF (recommended), Text files, Images. System will extract customer, vehicle, and invoice details automatically.</small>
            </div>
            <div id="uploadProgressContainer" style="display:none;">
              <div class="progress mb-2">
                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
              </div>
              <small id="uploadStatusText" class="text-muted">Uploading and processing document...</small>
            </div>
          </form>
        </div>
      </div>

      <!-- Uploaded Documents -->
      {% if documents %}
      <div class="row g-3">
        {% for doc in documents %}
        <div class="col-lg-6">
          <div class="card shadow-sm h-100" data-extraction-id="{% if doc.extraction %}{{ doc.extraction.id }}{% else %}{% endif %}">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1"><i class="fa fa-file-pdf me-2" style="color: #dc3545;"></i>{{ doc.file_name }}</h6>
                <small class="text-muted">
                  {{ doc.document_type|upper }} ï¿½ï¿½ {{ doc.uploaded_at|date:"M d, Y H:i" }}
                </small>
              </div>
              <span class="badge bg-{% if doc.extraction_status == 'completed' %}success{% elif doc.extraction_status == 'processing' %}warning{% else %}danger{% endif %}">
                {{ doc.extraction_status|title }}
              </span>
            </div>

            <div class="card-body">
              <p class="text-muted">Document uploaded.</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info text-center" role="alert">
        <i class="fa fa-info-circle me-2"></i>
        <strong>No documents uploaded yet.</strong> Upload an invoice or quotation to get started.
      </div>
      {% endif %}
    </div>

    <!-- Details Tab -->
    <div class="tab-pane fade" id="details">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if order.description %}
          <div class="mb-3">
            <small class="text-muted d-block">Description</small>
            <strong>{{ order.description }}</strong>
          </div>
          {% endif %}
          {% if order.estimated_duration %}
          <div class="mb-3">
            <small class="text-muted d-block">Estimated Duration</small>
            <strong>{{ order.estimated_duration }} minutes</strong>
          </div>
          {% endif %}
          {% if order.item_name %}
          <div class="mb-3">
            <small class="text-muted d-block">Item</small>
            <strong>{{ order.item_name }}</strong>
          </div>
          {% endif %}
          {% if order.brand %}
          <div class="mb-3">
            <small class="text-muted d-block">Brand</small>
            <strong>{{ order.brand }}</strong>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Include Extraction Form Modal -->
{% include 'tracker/modals/extraction_form_modal.html' %}

<!-- Unified Edit Details Modal -->
<div class="modal fade" id="editDetailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fa fa-edit me-2"></i><span id="editTitle">Edit Details</span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <!-- Customer Edit Form -->
      <form id="customerEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_customer">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Full Name</label>
            <input type="text" name="full_name" class="form-control" value="{{ customer.full_name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Phone</label>
            <input type="tel" name="phone" class="form-control" value="{{ customer.phone }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Email</label>
            <input type="email" name="email" class="form-control" value="{{ customer.email|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Address</label>
            <textarea name="address" class="form-control" rows="2">{{ customer.address|default:'' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Customer Type</label>
            <select name="customer_type" id="editCustomerType" class="form-select">
              <option value="personal" {% if customer.customer_type == 'personal' %}selected{% endif %}>Personal</option>
              <option value="company" {% if customer.customer_type == 'company' %}selected{% endif %}>Company</option>
              <option value="government" {% if customer.customer_type == 'government' %}selected{% endif %}>Government</option>
              <option value="ngo" {% if customer.customer_type == 'ngo' %}selected{% endif %}>NGO</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type != 'personal' %}d-none{% endif %}" id="editPersonalSubtypeField">
            <label class="form-label fw-bold">Personal Subtype</label>
            <select name="personal_subtype" class="form-select">
              <option value="owner" {% if customer.personal_subtype == 'owner' %}selected{% endif %}>Owner</option>
              <option value="driver" {% if customer.personal_subtype == 'driver' %}selected{% endif %}>Driver</option>
            </select>
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editOrganizationField">
            <label class="form-label fw-bold">Organization Name</label>
            <input type="text" name="organization_name" class="form-control" value="{{ customer.organization_name|default:'' }}">
          </div>
          <div class="mb-3 {% if customer.customer_type == 'personal' %}d-none{% endif %}" id="editTaxField">
            <label class="form-label fw-bold">Tax Number (TIN)</label>
            <input type="text" name="tax_number" class="form-control" value="{{ customer.tax_number|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>

      <!-- Vehicle Edit Form -->
      {% if vehicle %}
      <form id="vehicleEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_vehicle">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Plate Number</label>
            <input type="text" class="form-control" value="{{ vehicle.plate_number }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Vehicle Type</label>
            <input type="text" name="vehicle_type" class="form-control" value="{{ vehicle.vehicle_type|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Make</label>
            <input type="text" name="make" class="form-control" value="{{ vehicle.make|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Model</label>
            <input type="text" name="model" class="form-control" value="{{ vehicle.model|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<script>
let currentEditMode = 'customer';

function setEditMode(mode) {
  currentEditMode = mode;
  
  // Hide all forms
  document.getElementById('customerEditForm').style.display = 'none';
  if (document.getElementById('vehicleEditForm')) {
    document.getElementById('vehicleEditForm').style.display = 'none';
  }
  
  // Show selected form
  if (mode === 'customer') {
    document.getElementById('editTitle').textContent = 'Edit Customer Information';
    document.getElementById('customerEditForm').style.display = 'block';
    // Initialize extra fields visibility when switching to customer form
    if (typeof toggleCustomerExtraFields === 'function') { toggleCustomerExtraFields(); }
  } else if (mode === 'vehicle') {
    document.getElementById('editTitle').textContent = 'Edit Vehicle Information';
    document.getElementById('vehicleEditForm').style.display = 'block';
  }
}

// Dynamically show/hide fields based on customer type
function toggleCustomerExtraFields(){
  var sel = document.getElementById('editCustomerType');
  var type = sel ? String(sel.value).toLowerCase() : '';
  var personal = document.getElementById('editPersonalSubtypeField');
  var org = document.getElementById('editOrganizationField');
  var tax = document.getElementById('editTaxField');
  if (personal) {
    if (type === 'personal') { personal.classList.remove('d-none'); } else { personal.classList.add('d-none'); }
  }
  var showOrg = (type === 'company' || type === 'government' || type === 'ngo');
  if (org) { if (showOrg) { org.classList.remove('d-none'); } else { org.classList.add('d-none'); } }
  if (tax) { if (showOrg) { tax.classList.remove('d-none'); } else { tax.classList.add('d-none'); } }
}

// Attach change listener once DOM is ready
document.addEventListener('DOMContentLoaded', function(){
  var sel = document.getElementById('editCustomerType');
  if (sel) {
    sel.addEventListener('change', toggleCustomerExtraFields);
    toggleCustomerExtraFields();
  }
  // Also wire up when the modal opens, to handle dynamic DOM/visibility
  var editModal = document.getElementById('editDetailsModal');
  if (editModal) {
    editModal.addEventListener('shown.bs.modal', function(){
      var typeSel = document.getElementById('editCustomerType');
      if (typeSel) {
        // avoid double-binding by removing existing then adding
        typeSel.removeEventListener('change', toggleCustomerExtraFields);
        typeSel.addEventListener('change', toggleCustomerExtraFields);
        toggleCustomerExtraFields();
      }
    });
  }
});

// Complete Order Logic
document.addEventListener('DOMContentLoaded', function(){
  const completeBtn = document.getElementById('completeOrderBtn');
  if (!completeBtn) return;

  const orderStarted = {{ order.started_at|default:'None'|yesno:'true,false' }};
  const startedAtStr = '{{ order.started_at|date:"c" }}';
  const estimatedDuration = {{ order.estimated_duration|default:'null' }};

  function redirectToSignature(){
    window.location.href = '{% url "tracker:order_detail" pk=order.id %}';
  }

  completeBtn.addEventListener('click', function(e){
    const orderType = '{{ order.type|default:"" }}';

    // Only check overrun for service and sales orders with estimated duration
    if (orderType !== 'service' && orderType !== 'sales') {
      redirectToSignature();
      return;
    }

    // If no estimated duration, skip overrun check
    if (!estimatedDuration) {
      redirectToSignature();
      return;
    }

    if (!startedAtStr) { redirectToSignature(); return; }
    const startedAt = new Date(startedAtStr);
    const now = new Date();
    const elapsedMinutes = Math.floor((now - startedAt) / 60000);

    // If elapsed time is within or under estimated duration, proceed to signature
    if (elapsedMinutes <= (Number(estimatedDuration) || 0)){
      redirectToSignature();
      return;
    }

    // Exceeded ETA -> show modal to collect reason
    const overrunModalEl = document.getElementById('overrunReasonModal');
    const overrunModal = new bootstrap.Modal(overrunModalEl);
    overrunModal.show();
  });

  // Save reason handler
  const saveBtn = document.getElementById('saveOverrunReasonBtn');
  if (saveBtn){
    saveBtn.addEventListener('click', function(){
      const reason = document.getElementById('overrunReasonInput').value.trim();
      const errEl = document.getElementById('overrunReasonError');
      errEl.style.display = 'none';
      if (!reason){ errEl.textContent = 'Please enter a reason for the delay.'; errEl.style.display = ''; return; }

      fetch('{% url "tracker:api_report_overrun" order_id=order.id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken() || '',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ reason: reason })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success){
          const modalEl = document.getElementById('overrunReasonModal');
          const modal = bootstrap.Modal.getInstance(modalEl);
          if (modal) modal.hide();
          redirectToSignature();
        } else {
          errEl.textContent = data.error || 'Failed to save reason'; errEl.style.display = '';
        }
      })
      .catch(err => {
        console.error('Error saving overrun reason', err);
        errEl.textContent = 'Server error saving reason'; errEl.style.display = '';
      });
    });
  }
});


</script>

<!-- Extraction Form Modal JavaScript -->
<script src="{% static 'js/extraction_form_modal.js' %}"></script>

<script>
  // Initialize extraction form modal for started orders
  document.addEventListener('DOMContentLoaded', function() {
    // Create hidden inputs for extraction modal to access
    const orderTypeInput = document.createElement('input');
    orderTypeInput.type = 'hidden';
    orderTypeInput.name = 'order_type';
    orderTypeInput.value = '{{ order.type|default:"service" }}';
    document.body.appendChild(orderTypeInput);

    const orderIdInput = document.createElement('input');
    orderIdInput.type = 'hidden';
    orderIdInput.name = 'order_id';
    orderIdInput.value = '{{ order.id }}';
    document.body.appendChild(orderIdInput);
  });
</script>

{% endblock %}
